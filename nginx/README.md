# Nginx — раздача фронтенда по HTTP

Конфигурация nginx для раздачи статики SPA-фронтенда по порту 80 без привязки к домену (доступ по IP). Обновление конфигурации на сервере выполняется **только через CI/CD** при push в ветку `main`.

## Содержимое

| Файл | Назначение |
|------|------------|
| `frontend.conf.template` | Шаблон виртуального хоста. Директива `root` подставляется из секрета `ROOT_PATH` при деплое. |
| `frontend.conf` | Генерируется в CI из шаблона; в репозитории хранится для справки (путь по умолчанию). На сервер выкатывается только артефакт из пайплайна. |

## Секреты репозитория

В настройках репозитория (Settings → Secrets and variables → Actions) должны быть заданы:

| Секрет | Описание |
|--------|----------|
| `SSH_PRIVATE_KEY` | Приватный ключ для доступа к серверу по SSH. |
| `SSH_HOST` | Хост сервера (IP или домен). |
| `SSH_USER` | Имя пользователя для SSH. |
| `ROOT_PATH` | Абсолютный путь к каталогу с собранным фронтендом на сервере (тот же путь, что и `REMOTE_PATH` в репозитории Frontend). Пример: `/home/kizhinov/Petergof/frontend`. |

Пользователь `SSH_USER` на сервере должен иметь право выполнять без пароля: `sudo cp`, `sudo ln`, `sudo rm` (в каталогах nginx), `sudo nginx -t`, `sudo systemctl reload nginx`.

## Как обновить конфиг

1. Внести изменения в `frontend.conf.template` (или в шаблоны других конфигов при их появлении).
2. Закоммитить и запушить в ветку `main`.
3. Workflow «Deploy infrastructure» (.github/workflows/deploy.yml) выполнится автоматически: подставит `ROOT_PATH` в шаблон, загрузит конфиг на сервер в `/etc/nginx/sites-available/`, включит его в `sites-enabled`, отключит дефолтный сайт nginx, проверит конфиг (`nginx -t`) и перезагрузит nginx.

Ручное изменение конфигов в `/etc/nginx/` на сервере не предполагается: при следующем деплое они будут перезаписаны из репозитория.

## Требования на сервере

- Установлен nginx (например, пакет `nginx` в Debian/Ubuntu).
- Каталог из `ROOT_PATH` существует и содержит собранный фронтенд (результат деплоя из репозитория Frontend).

## Поведение конфигурации

- **Порт 80, default_server** — запросы по IP без домена обрабатываются этим виртуальным хостом.
- **SPA** — для несуществующих путей возвращается `index.html` (`try_files ... /index.html`), роутинг выполняется на стороне приложения.
- **Кэширование** — для статических ресурсов (JS, CSS, шрифты, изображения) выставляется длительный кэш.

## Логи nginx

- Доступ: `/var/log/nginx/frontend_access.log`
- Ошибки: `/var/log/nginx/frontend_error.log`
