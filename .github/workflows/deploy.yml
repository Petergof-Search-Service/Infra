name: Deploy Infrastructure

on:
  push:
    branches: [main]
  pull_request:
  repository_dispatch:
    types: [frontend-updated, frontend-test-updated, api-updated, api-test-updated]
  workflow_dispatch:

env:
  REMOTE_PATH: "~/Petergof/infrastructure"
  REMOTE_PATH_TEST: "~/Petergof/infrastructure-test"

jobs:
  deploy-prod:
    name: Deploy to prod
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'repository_dispatch' && (github.event.action == 'frontend-updated' || github.event.action == 'api-updated'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Ensure remote path exists
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ env.REMOTE_PATH }}"

      - name: Generate nginx config
        run: sed 's/{{DOMAIN}}/petergof-sciense-rag.ru/g' nginx/default.conf.template > nginx/default.conf

      - name: Create .env for prod
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
          REFRESH_TOKEN_EXPIRE_DAYS: ${{ secrets.REFRESH_TOKEN_EXPIRE_DAYS }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          JWT_ALGORITHM: ${{ secrets.JWT_ALGORITHM }}
          FRONTEND_IMAGE: ${{ github.event.action == 'frontend-updated' && github.event.client_payload.image || '' }}
          API_IMAGE: ${{ github.event.action == 'api-updated' && github.event.client_payload.image || '' }}
        run: |
          echo "POSTGRES_USER=$POSTGRES_USER" > .env
          echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env
          echo "POSTGRES_DB=$POSTGRES_DB" >> .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=$ACCESS_TOKEN_EXPIRE_MINUTES" >> .env
          echo "REFRESH_TOKEN_EXPIRE_DAYS=$REFRESH_TOKEN_EXPIRE_DAYS" >> .env
          echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" >> .env
          echo "JWT_ALGORITHM=$JWT_ALGORITHM" >> .env
          echo "FRONTEND_IMAGE=$FRONTEND_IMAGE" >> .env
          echo "API_IMAGE=$API_IMAGE" >> .env

      - name: Deploy config to server (on push to main)
        if: github.event_name == 'push'
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            . \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.REMOTE_PATH }}/

      - name: Upload .env to server (on dispatch)
        run: |
          scp -o StrictHostKeyChecking=no .env ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.REMOTE_PATH }}/.env

      - name: Deploy / update containers
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ env.REMOTE_PATH }} && docker compose --env-file .env pull && docker compose --env-file .env up -d --remove-orphans && docker image prune -f"

      - name: Show container logs on failure
        if: failure()
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ env.REMOTE_PATH }} && echo '=== API logs ===' && docker compose logs --tail=200 api && echo '=== DB logs ===' && docker compose logs --tail=100 db"

      - name: Healthcheck
        run: |
          sleep 5
          curl -f -s -o /dev/null -k --connect-timeout 10 --max-time 15 --retry 3 --retry-delay 5 "https://petergof-sciense-rag.ru/"

  deploy-test:
    name: Deploy to test
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch' && (github.event.action == 'frontend-test-updated' || github.event.action == 'api-test-updated') || github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_TEST }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST_TEST }} >> ~/.ssh/known_hosts

      - name: Ensure remote path exists
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER_TEST }}@${{ secrets.SSH_HOST_TEST }} "mkdir -p ${{ env.REMOTE_PATH_TEST }}"

      - name: Generate nginx config
        run: sed 's/{{DOMAIN}}/test.petergof-sciense-rag.ru/g' nginx/default.conf.template > nginx/default.conf

      - name: Create .env for test
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER_TEST }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD_TEST }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
          REFRESH_TOKEN_EXPIRE_DAYS: ${{ secrets.REFRESH_TOKEN_EXPIRE_DAYS }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY_TEST }}
          JWT_ALGORITHM: ${{ secrets.JWT_ALGORITHM }}
          FRONTEND_IMAGE: ${{ github.event_name == 'pull_request' && 'ghcr.io/petergof-search-service/frontend:latest' || (github.event.action == 'frontend-test-updated' && github.event.client_payload.image) || '' }}
          API_IMAGE: ${{ github.event.action == 'api-test-updated' && github.event.client_payload.image || (github.event_name == 'pull_request' && 'ghcr.io/petergof-search-service/api:latest') || '' }}
        run: |
          echo "POSTGRES_USER=$POSTGRES_USER" > .env &&
          echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env &&
          echo "POSTGRES_DB=$POSTGRES_DB" >> .env &&
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=$ACCESS_TOKEN_EXPIRE_MINUTES" >> .env &&
          echo "REFRESH_TOKEN_EXPIRE_DAYS=$REFRESH_TOKEN_EXPIRE_DAYS" >> .env &&
          echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" >> .env &&
          echo "JWT_ALGORITHM=$JWT_ALGORITHM" >> .env &&
          echo "FRONTEND_IMAGE=$FRONTEND_IMAGE" >> .env &&
          echo "API_IMAGE=$API_IMAGE" >> .env

      - name: Deploy config to test server
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            . \
            ${{ secrets.SSH_USER_TEST }}@${{ secrets.SSH_HOST_TEST }}:${{ env.REMOTE_PATH_TEST }}/

      - name: Upload .env to test server
        run: |
          scp -o StrictHostKeyChecking=no .env ${{ secrets.SSH_USER_TEST }}@${{ secrets.SSH_HOST_TEST }}:${{ env.REMOTE_PATH_TEST }}/.env

      - name: Deploy / update containers
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER_TEST }}@${{ secrets.SSH_HOST_TEST }} \
            "cd ${{ env.REMOTE_PATH_TEST }} && docker compose --env-file .env down && docker compose --env-file .env pull && docker compose --env-file .env up -d --remove-orphans && docker image prune -f"

      - name: Show container logs on failure
        if: failure()
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER_TEST }}@${{ secrets.SSH_HOST_TEST }} \
            "cd ${{ env.REMOTE_PATH_TEST }} && echo '=== API logs ===' && docker compose logs --tail=200 api && echo '=== DB logs ===' && docker compose logs --tail=100 db"

      - name: Healthcheck
        run: |
          sleep 5
          curl -f -s -o /dev/null -k --connect-timeout 10 --max-time 15 --retry 3 --retry-delay 5 "https://test.petergof-sciense-rag.ru/"
